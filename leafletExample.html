<html>
<head>
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css"
   integrity="sha512-wcw6ts8Anuw10Mzh9Ytw4pylW8+NAD4ch3lqm9lzAsTxg0GFeJgoAtxuCLREZSC5lUXdVyo/7yfsqFjQ4S+aKw=="
   crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.1.0/dist/leaflet.js"
   integrity="sha512-mNqn2Wg7tSToJhvHcqfzLMU6J4mkOImSPTxVZAdo+lcPlk+GhZmYgACEe0x35K7YzW1zJ7XyJV/TT1MrdXvMcA=="
   crossorigin=""></script>


<!-- the following links incorporate the CSS required for custom icon creation --> 
<link rel="stylesheet" href="css/ionicons.min.css"> 
<link rel="stylesheet" href="css/leaflet.awesome-markers.css"> 
<script src="js/leaflet.awesome-markers.js"></script>

  <style type="text/css"> 
#mapid { height: 180px; }
  </style>

</head>
<body>



<div id="mapid" style="width: 600px; height: 400px;"></div>
<script>

  var mymap; // global variable to store the map

  // create a custom popup as a global variable
  var popup = L.popup();

  // create an event detector to wait for the user's click event and then use the popup to show them where they clicked 
  // note that you don't need to do any complicated maths to convert screen coordinates to real world coordiantes - the Leaflet API does this for you

// create a variable that will hold the XMLHttpRequest() - this must be done outside a function so that all the functions can use the same variable
var client;

// create the code to get the Earthquakes data using an XMLHttpRequest
function getEarthquakes() {
   client = new XMLHttpRequest();
   client.open('GET','https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_hour.geojson');
   client.onreadystatechange = earthquakeResponse;  // note don't use earthquakeResponse() with brackets as that doesn't work
   client.send();
}
// create the code to wait for the response from the data server, and process the response once it is received
function earthquakeResponse() {
  // this function listens out for the server to say that the data is ready - i.e. has state 4
  if (client.readyState == 4) {
    // once the data is ready, process the data
    var earthquakedata = client.responseText;
    loadGeoJSONLayer(earthquakedata);
    }
}
// convert the received data - which is text - to JSON format and add it to the map
function loadGeoJSONLayer(earthquakedata) {
    // convert the text to JSON
    var earthquakejson = JSON.parse(earthquakedata);

    // add the JSON layer onto the map - it will appear using the default icons
    geojsonLayer = L.geoJson(earthquakejson).addTo(mymap);

    // change the map zoom so that all the data is shown
    mymap.fitBounds(geojsonLayer.getBounds());
}

  function onMapClick(e) {
    popup
          .setLatLng(e.latlng) 
          .setContent("You clicked the map at " + e.latlng.toString()) 
          .openOn(mymap);
  }



  function loadLeafletMap() {
    mymap = L.map('mapid').setView([51.505, -0.09], 13);


  // load the tiles

  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', { 
    maxZoom: 18, 
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' + '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' + 'Imagery Â© <a href="http://mapbox.com">Mapbox</a>', 
    id: 'mapbox.streets' 
  }).addTo(mymap);

  // now add the click event detector to the map 
  mymap.on('click', onMapClick);


  // now call the code to add the markers 
  addBasicMarkers();

  } //end code to add the leaflet map


  var testMarkerPink = L.AwesomeMarkers.icon({
    icon: 'play', 
    markerColor: 'pink'
  });


  function addBasicMarkers() {
  // create a geoJSON feature -
  var geojsonFeature = {
    "type": "Feature",
    "properties": { 
      "name": "London", 
      "popupContent": "This is where UCL is based"
    },
    "geometry": { 
      "type": "Point", 
      "coordinates": [-0.133583, 51.524776] 
    } 
  }; 

  // and add it to the map 
  L.geoJSON(geojsonFeature).addTo(mymap).bindPopup("<b>"+geojsonFeature.properties.name+" "+geojsonFeature.properties.popupContent+"<b>");

  L.geoJSON(geojsonFeature, { 
    pointToLayer: function (feature, latlng) { 
      return L.marker(latlng, {icon:testMarkerPink});
    } 
  }).addTo(mymap).bindPopup("<b>"+geojsonFeature.properties.name+" "+geojsonFeature.properties.popupContent+"<b>");

  // add a point
  L.marker([51.5, -0.09]).addTo(mymap)
    .bindPopup("<b>Hello world!</b><br />I am a popup.").openPopup();

  // add a circle
  L.circle([51.508, -0.11], 500, {
     color: 'red', 
     fillColor: '#f03', 
     fillOpacity: 0.5
  }).addTo(mymap).bindPopup("I am a circle."); 

  // add a polygon with 3 end points (i.e. a triangle) 
  var myPolygon = L.polygon([ 
    [51.509, -0.08], 
    [51.503, -0.06], 
    [51.51, -0.047]
  ],{
    color: 'red', 
    fillColor: '#f03', 
    fillOpacity: 0.5 
  }).addTo(mymap).bindPopup("I am a polygon."); 
} // end code to add the basic markers

document.addEventListener('DOMContentLoaded', function() {
    loadMap();
}, false);

function loadMap() { 
  loadLeafletMap(); 
  getEarthquakes(); 
}

</script>



</body>
</html>




</body>